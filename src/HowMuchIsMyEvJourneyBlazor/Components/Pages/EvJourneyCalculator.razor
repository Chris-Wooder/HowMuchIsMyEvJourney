@page "/"
@using HowMuchIsMyEvJourneyBlazor.Models
@using Microsoft.Extensions.Configuration
@inject IConfiguration Configuration
@rendermode InteractiveServer

<PageTitle>EV Journey Calculator</PageTitle>

<h1>EV Journey Cost Calculator</h1>

<p>Calculate the cost of your electric vehicle journey based on battery usage and charging information.</p>

<div class="row">
    <div class="col-md-8">
        <EditForm Model="@calculation" OnValidSubmit="@CalculateJourneyCost">
            <DataAnnotationsValidator />
            
            <div class="card mb-3">
                <div class="card-header">
                    <h5>Tariff Information</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="offPeakTariff" class="form-label">Off-Peak Tariff (pence/kWh):</label>
                        <InputNumber id="offPeakTariff" class="form-control" @bind-Value="calculation.OffPeakTariffPencePerKwh" />
                    </div>
                    
                    <div class="mb-3">
                        <label for="onPeakTariff" class="form-label">On-Peak Tariff (pence/kWh):</label>
                        <InputNumber id="onPeakTariff" class="form-control" @bind-Value="calculation.OnPeakTariffPencePerKwh" />
                    </div>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header">
                    <h5>Battery Information</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="batterySizeKwh" class="form-label">Battery Size (kWh):</label>
                        <InputNumber id="batterySizeKwh" class="form-control" @bind-Value="calculation.BatterySizeKwh" />
                    </div>

                    <div class="mb-3">
                        <label for="batteryStart" class="form-label">Battery Charge at Start (%):</label>
                        <InputNumber id="batteryStart" class="form-control" @bind-Value="calculation.BatteryChargeStartPercent" />
                    </div>
                    
                    <div class="mb-3">
                        <label for="batteryEnd" class="form-label">Battery Charge at End (%):</label>
                        <InputNumber id="batteryEnd" class="form-control" @bind-Value="calculation.BatteryChargeEndPercent" />
                    </div>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header">
                    <h5>Journey Information</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="distance" class="form-label">Distance:</label>
                        <div class="input-group">
                            <InputNumber id="distance" class="form-control" @bind-Value="calculation.Distance" />
                            <InputSelect class="form-select" @bind-Value="calculation.DistanceUnit" style="max-width: 150px;">
                                <option value="@DistanceUnit.Kilometers">Kilometers</option>
                                <option value="@DistanceUnit.Miles">Miles</option>
                            </InputSelect>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header">
                    <h5>Fuel Comparison</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="fuelEfficiencyMpg" class="form-label">Fuel Efficiency (MPG):</label>
                        <InputNumber id="fuelEfficiencyMpg" class="form-control" @bind-Value="calculation.FuelEfficiencyMpg" />
                        <div class="form-text">Miles per gallon for diesel/petrol vehicle</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="fuelCostPerLitre" class="form-label">Fuel Cost per Litre (£):</label>
                        <InputNumber id="fuelCostPerLitre" class="form-control" @bind-Value="calculation.FuelCostPerLitre" />
                        <div class="form-text">Cost of diesel/petrol per litre</div>
                    </div>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header">
                    <h5>Public Charging</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3 form-check">
                        <InputCheckbox id="publicCharging" class="form-check-input" @bind-Value="calculation.ChargedAtPublicInfrastructure" />
                        <label for="publicCharging" class="form-check-label">
                            Charged at public infrastructure
                        </label>
                    </div>
                    
                    @if (calculation.ChargedAtPublicInfrastructure)
                    {
                        <div class="mb-3">
                            <label for="publicEnergy" class="form-label">Energy Added at Public Infrastructure (kWh):</label>
                            <InputNumber id="publicEnergy" class="form-control" @bind-Value="calculation.PublicChargingEnergyKwh" />
                        </div>
                        
                        <div class="mb-3">
                            <label for="publicCost" class="form-label">Cost at Public Infrastructure (pence/kWh):</label>
                            <InputNumber id="publicCost" class="form-control" @bind-Value="calculation.PublicChargingCostPencePerKwh" />
                        </div>
                    }
                </div>
            </div>

            <div class="mb-3">
                <button type="submit" class="btn btn-primary">Calculate Journey Cost</button>
            </div>
        </EditForm>

        @if (result != null)
        {
            <div class="card mt-4">
                <div class="card-header bg-success text-white">
                    <h5>Journey Cost Results</h5>
                </div>
                <div class="card-body">
                    <table class="table table-striped">
                        <tbody>
                            <tr>
                                <td><strong>Total Energy Used:</strong></td>
                                <td>@result.EnergyUsedKwh kWh</td>
                            </tr>
                            <tr>
                                <td><strong>Energy from Home Charging:</strong></td>
                                <td>@result.EnergyFromHomeKwh kWh</td>
                            </tr>
                            @if (result.PublicChargingEnergyKwh > 0)
                            {
                                <tr>
                                    <td><strong>Public Charging Energy:</strong></td>
                                    <td>@result.PublicChargingEnergyKwh kWh</td>
                                </tr>
                            }
                            <tr>
                                <td><strong>Home Charging Cost:</strong></td>
                                <td>@result.HomeChargeCostPence p</td>
                            </tr>
                            @if (result.PublicChargeCostPence > 0)
                            {
                                <tr>
                                    <td><strong>Public Charging Cost:</strong></td>
                                    <td>@result.PublicChargeCostPence p</td>
                                </tr>
                            }
                            <tr class="table-success">
                                <td><strong>Total EV Cost:</strong></td>
                                <td><strong>£@result.TotalCostPounds</strong></td>
                            </tr>
                        </tbody>
                    </table>
                    
                    @if (result.FuelCostPounds > 0)
                    {
                        <hr />
                        <h6 class="mt-3">Fuel Vehicle Comparison</h6>
                        <table class="table table-striped">
                            <tbody>
                                <tr>
                                    <td><strong>Fuel Vehicle Cost:</strong></td>
                                    <td>£@result.FuelCostPounds</td>
                                </tr>
                                <tr class="@(result.SavingsPounds >= 0 ? "table-success" : "table-danger")">
                                    <td><strong>Savings with EV:</strong></td>
                                    <td><strong>£@result.SavingsPounds</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    }
                </div>
            </div>
        }
    </div>
</div>

@code {
    private EvJourneyCalculation calculation = new()
    {
        OffPeakTariffPencePerKwh = 7.5,
        OnPeakTariffPencePerKwh = 15.0,
        BatterySizeKwh = 64.0,
        BatteryChargeStartPercent = 80.0,
        BatteryChargeEndPercent = 20.0,
        ChargedAtPublicInfrastructure = false,
        PublicChargingEnergyKwh = 0,
        PublicChargingCostPencePerKwh = 0,
        Distance = 0,
        DistanceUnit = DistanceUnit.Kilometers,
        DistanceKm = 0,
        FuelEfficiencyMpg = 0,
        FuelCostPerLitre = 0
    };

    private EvJourneyResult? result;

    protected override void OnInitialized()
    {
        // Load default values from configuration
        calculation.FuelEfficiencyMpg = Configuration.GetValue<double>("FuelComparison:DefaultMpg", 50.0);
        calculation.FuelCostPerLitre = Configuration.GetValue<double>("FuelComparison:DefaultCostPerLitre", 1.45);
    }

    private void CalculateJourneyCost()
    {
        result = calculation.Calculate();
    }
}
